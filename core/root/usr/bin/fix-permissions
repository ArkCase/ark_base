#!/bin/bash

# Allow this script to fail without failing a build
set +e

# If argument does not exist, script will still exit with 0,
# but at least we'll see something went wrong in the log
TARGET="${1}"
if ! [ -e "${TARGET}" ] ; then
	echo "ERROR: File or directory [${TARGET}] does not exist." >&2
	# We still want to end successfully
	exit 0
fi

SYMLINK_OPT="${2:-"-L"}"

# Fix permissions on the given directory or file to allow group read/write of
# regular files and execute of directories.

MY_UID="$(id -u)"
[ ${MY_UID} -ne 0 ] && CHECK_OWNER=" -uid ${MY_UID}"

find ${SYMLINK_OPT} "${TARGET}" ${CHECK_OWNER} \! -gid 0 -exec chgrp 0 {} +
find ${SYMLINK_OPT} "${TARGET}" ${CHECK_OWNER} \! -perm -g+rw -exec chmod g+rw {} +
find ${SYMLINK_OPT} "${TARGET}" ${CHECK_OWNER} -perm /u+x -a \! -perm /g+x -exec chmod g+x {} +
find ${SYMLINK_OPT} "${TARGET}" ${CHECK_OWNER} -type d \! -perm /g+x -exec chmod g+x {} +

# Always end successfully
exit 0
